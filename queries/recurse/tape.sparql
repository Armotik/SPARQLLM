# run with slm-run --load ./data/tape.nq --format nquads --config config.ini -f queries/tape.sparql --debug

PREFIX ex: <http://example.org/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>

SELECT * WHERE {
  BIND("""
    PREFIX ex: <http://example.org/>
    PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
    CONSTRUCT {
      ex:head ex:at ?next_cell .
      ex:head ex:state ?new_state.
      ?cell ex:value ?value . #coalesce
      ?cell ex:right ?nextcell .
      ?next_cell ex:value ?next_value .
    }
    WHERE {
      { GRAPH ?gin {
        ex:head ex:at ?cell ;
                ex:state ?current_state .
        ?cell ex:value ?current_value ;
              ex:right ?next_cell .
        ?next_cell ex:value ?next_value .
        }
      } UNION {
        GRAPH ?gin {
        ex:head ex:at ?cell ;
                ex:state ?current_state .
        ?cell ex:value ?current_value ;
              ex:right ?next_cell .
        ?next_cell ex:value ?next_value .
        }
        GRAPH <http://example.org/Transition> {
        ?t ex:fromState ?current_state ;
           ex:read ?current_value ;
           ex:toState ?new_state ;
           ex:write ?new_value ;
           ex:move 'R' .
        }
      } # union
      BIND(COALESCE(?new_value,?current_value) as ?value)

    } #where 
  """ AS ?query_str)

  BIND(ex:SLM-RECURSE(?query_str, <http://example.org/InitialTapeGraph>, 10) AS ?final_graph)

  GRAPH ?final_graph { 
    {
       ex:head ex:at ?head .
       ex:head ex:state ?state 
    } union {
      ?cell ex:value ?value ; #coalesce
    }

  }   
}
